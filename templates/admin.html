
{% extends "base.html" %}

{% block title %}TradingView Access Manager{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-cogs text-primary me-2"></i>TradingView Access Manager</h1>
            <p class="text-muted">Grant access to Pine Scripts and manage user permissions</p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5><i class="fas fa-script me-2"></i>Total Scripts</h5>
                    <h2>{{ total_scripts }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5><i class="fas fa-users me-2"></i>Total Access Granted</h5>
                    <h2>{{ total_access }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Grant Access Section -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-user-plus me-2"></i>Grant Script Access</h5>
                </div>
                <div class="card-body">
                    <form id="accessForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">TradingView Username</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="username" placeholder="Enter username">
                                <button class="btn btn-outline-secondary" type="button" id="validateBtn">
                                    <i class="fas fa-check me-1"></i>Validate
                                </button>
                            </div>
                            <div id="usernameValidation" class="form-text"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Select Pine Scripts</label>
                            <div class="row">
                                {% for script in scripts %}
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input script-checkbox" type="checkbox" value="{{ script.pine_id }}" id="script{{ loop.index }}">
                                        <label class="form-check-label" for="script{{ loop.index }}">
                                            <strong>{{ script.name }}</strong>
                                            <small class="text-muted d-block">{{ script.description }}</small>
                                        </label>
                                        <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="getScriptUsers('{{ script.pine_id }}', '{{ script.name }}')">
                                            <i class="fas fa-users me-1"></i>View Users
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="toggleSelectAll()">
                                <i class="fas fa-check-square me-1"></i>Select All
                            </button>
                        </div>

                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus me-2"></i>Grant Access
                        </button>
                    </form>

                    <div id="accessResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Script Management -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-script me-2"></i>Script Management</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addScriptModal">
                        <i class="fas fa-plus me-2"></i>Add Script
                    </button>

                    <div class="list-group">
                        {% for script in scripts[:5] %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ script.name }}</strong>
                                <small class="text-muted d-block">{{ script.pine_id[:20] }}...</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeScript('{{ script.pine_id }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Access Logs -->
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history me-2"></i>Recent Access Activity</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Script</th>
                                    <th>Operation</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in access_logs %}
                                <tr>
                                    <td><strong>{{ log.username }}</strong></td>
                                    <td>{{ log.pine_script_name }}</td>
                                    <td>
                                        <span class="badge bg-{% if log.operation == 'grant' %}success{% else %}warning{% endif %}">
                                            {{ log.operation.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if log.status == 'success' %}success{% else %}danger{% endif %}">
                                            {{ log.status.title() }}
                                        </span>
                                    </td>
                                    <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        {% if log.operation == 'grant' and log.status == 'success' %}
                                        <button class="btn btn-sm btn-outline-danger" onclick="removeUserAccess('{{ log.username }}', '{{ log.pine_id }}')">
                                            <i class="fas fa-times me-1"></i>Remove
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Script Modal -->
<div class="modal fade" id="addScriptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Pine Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addScriptForm">
                    <div class="mb-3">
                        <label for="scriptName" class="form-label">Script Name</label>
                        <input type="text" class="form-control" id="scriptName" required>
                    </div>
                    <div class="mb-3">
                        <label for="scriptId" class="form-label">Script ID</label>
                        <input type="text" class="form-control" id="scriptId" placeholder="PUB;xxxxxxx..." required>
                        <div class="form-text">Pine Script publication ID (e.g., PUB;abc123...)</div>
                    </div>
                    <div class="mb-3">
                        <label for="scriptDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="scriptDescription" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addScript()">Add Script</button>
            </div>
        </div>
    </div>
</div>

<!-- View Script Users Modal -->
<div class="modal fade" id="scriptUsersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Users with Access to <span id="scriptNameTitle"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scriptUsersContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let usernameValid = false;
let allSelected = false;

// Username validation
document.getElementById('validateBtn').addEventListener('click', function() {
    const username = document.getElementById('username').value.trim();
    const validationDiv = document.getElementById('usernameValidation');
    
    if (!username) {
        validationDiv.innerHTML = '<span class="text-danger">Please enter a username</span>';
        return;
    }
    
    this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Validating...';
    this.disabled = true;
    
    fetch('/api/validate-username', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username: username})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            validationDiv.innerHTML = `<span class="text-success"><i class="fas fa-check me-1"></i>Valid user: ${data.verified_name}</span>`;
            usernameValid = true;
        } else {
            validationDiv.innerHTML = `<span class="text-danger"><i class="fas fa-times me-1"></i>${data.error}</span>`;
            usernameValid = false;
        }
    })
    .finally(() => {
        this.innerHTML = '<i class="fas fa-check me-1"></i>Validate';
        this.disabled = false;
    });
});

// Form submission
document.getElementById('accessForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!usernameValid) {
        alert('Please validate the username first');
        return;
    }
    
    const username = document.getElementById('username').value.trim();
    const selectedScripts = Array.from(document.querySelectorAll('.script-checkbox:checked')).map(cb => cb.value);
    
    if (selectedScripts.length === 0) {
        alert('Please select at least one script');
        return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Granting Access...';
    submitBtn.disabled = true;
    
    fetch('/api/grant-access', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username: username, scripts: selectedScripts})
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('accessResult');
        
        if (data.success) {
            let html = '<div class="alert alert-success"><h6>Access Granted Successfully!</h6><ul>';
            data.results.forEach(result => {
                html += `<li>${result.script_name}</li>`;
            });
            html += '</ul></div>';
            
            if (data.errors.length > 0) {
                html += '<div class="alert alert-warning"><h6>Some errors occurred:</h6><ul>';
                data.errors.forEach(error => {
                    html += `<li>${error.script_name}: ${error.error}</li>`;
                });
                html += '</ul></div>';
            }
            
            resultDiv.innerHTML = html;
            
            // Reset form
            document.getElementById('accessForm').reset();
            usernameValid = false;
            document.getElementById('usernameValidation').innerHTML = '';
            
            // Reload page after 3 seconds
            setTimeout(() => location.reload(), 3000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.script-checkbox');
    allSelected = !allSelected;
    
    checkboxes.forEach(cb => {
        cb.checked = allSelected;
    });
    
    const btn = event.target.closest('button');
    btn.innerHTML = allSelected 
        ? '<i class="fas fa-square me-1"></i>Deselect All'
        : '<i class="fas fa-check-square me-1"></i>Select All';
}

function getScriptUsers(scriptId, scriptName) {
    document.getElementById('scriptNameTitle').textContent = scriptName;
    
    const modal = new bootstrap.Modal(document.getElementById('scriptUsersModal'));
    modal.show();
    
    fetch(`/api/get-script-users/${scriptId}`)
    .then(response => response.json())
    .then(data => {
        const contentDiv = document.getElementById('scriptUsersContent');
        
        if (data.success && data.users.length > 0) {
            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Username</th><th>Access Type</th><th>Expiration</th><th>Created</th></tr></thead><tbody>';
            
            data.users.forEach(user => {
                html += `
                    <tr>
                        <td><strong>${user.username}</strong></td>
                        <td><span class="badge bg-${user.has_lifetime_access ? 'success' : 'warning'}">${user.has_lifetime_access ? 'Lifetime' : 'Temporary'}</span></td>
                        <td>${user.expiration ? new Date(user.expiration).toLocaleDateString() : 'Never'}</td>
                        <td>${user.created ? new Date(user.created).toLocaleDateString() : '-'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            html += `<p class="text-muted mt-3">Total users: ${data.users.length}</p>`;
            contentDiv.innerHTML = html;
        } else {
            contentDiv.innerHTML = '<div class="alert alert-info">No users found with access to this script.</div>';
        }
    })
    .catch(error => {
        document.getElementById('scriptUsersContent').innerHTML = '<div class="alert alert-danger">Error loading users.</div>';
    });
}

function addScript() {
    const name = document.getElementById('scriptName').value.trim();
    const scriptId = document.getElementById('scriptId').value.trim();
    const description = document.getElementById('scriptDescription').value.trim();
    
    if (!name || !scriptId) {
        alert('Please fill in required fields');
        return;
    }
    
    fetch('/api/add-script', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name, script_id: scriptId, description: description})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error);
        }
    });
}

function removeScript(scriptId) {
    if (!confirm('Are you sure you want to remove this script?')) return;
    
    fetch('/api/remove-script', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({script_id: scriptId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error);
        }
    });
}

function removeUserAccess(username, scriptId) {
    if (!confirm(`Remove access for ${username}?`)) return;
    
    fetch('/api/remove-access', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username: username, script_id: scriptId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    });
}
</script>
{% endblock %}
